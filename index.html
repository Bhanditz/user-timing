<!DOCTYPE html>
<html>
  <head>
    <title>
      User Timing Level 2
    </title>
    <meta charset="utf-8">
    <script src='//www.w3.org/Tools/respec/respec-w3c-common' class='remove'>
    </script>
    <script class="remove">
      // (this is to make tidy happy)
      // See http://www.w3.org/respec/ for ReSpec documentation.
      var respecConfig = {
          specStatus: "ED",
          shortName: "user-timing",
          maxTocLevel: 2,

          edDraftURI: "https://w3c.github.io/user-timing/",

          editors: [
            {
              name: "Jatinder Mann",
              company: "Microsoft Corp.",
              email: "jmann@microsoft.com",
              w3cid: "44357"
            },
            {
              name: "Zhiheng Wang",
              company: "Google Inc.",
              note: "Until July 2013",
              w3cid: "43685"
            },
            {
              name: "Anderson Quach",
              company: "Microsoft Corp.",
              note: "until March 2011",
              w3cid: "45288"
            }
          ],

          wg: "Web Performance Working Group",
          wgURI: "http://www.w3.org/2010/webperf/",
          wgPublicList: "public-web-perf",
          subjectPrefix: "[UserTiming]",

          // This is important for Rec-track documents, do not copy a patent URI
          // from a random document unless you know what you're doing. If in
          // doubt ask your friendly neighbourhood Team Contact.
          wgPatentURI:  "https://www.w3.org/2004/01/pp-impl/45211/status",

          noLegacyStyle: true,

          otherLinks: [{
             key: 'Repository',
             data: [{
               value: 'We are on GitHub',
               href: 'https://github.com/w3c/user-timing/'
             }, {
               value: 'Commit history',
               href: 'https://github.com/w3c/user-timing/commits/gh-pages/index.html'
             }, {
               value: 'File a bug',
               href: 'https://github.com/w3c/user-timing/issues'
             }]
           }]
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      <p>This specification defines an interface to help web
    developers measure the performance of their applications by giving them access
    to high precision timestamps.</p>
    </section>

    <section id='sotd'>
    <p>This new version is aligned with [[HR-TIME-2]] and [[!PERFORMANCE-TIMELINE-2]].</p>
    <p>This is a <strong>work in progress</strong> and may change without any notices.</p>
    </section>

    <section class='informative' id="introduction">
    <h2>
        Introduction
    </h2>
    <p>Web developers need the ability to assess and understand the performance characteristics of their
    applications. While JavaScript <a href='#ECMA262'>[ECMA262]</a> provides a mechanism to measure application latency (retrieving the current
    timestamp from the <code>Date.now()</code> method), the precision of this timestamp varies between user agents.</p>
    <p>This document defines the <a>PerformanceMark</a> and
	<a>PerformanceMeasure</a> interfaces, and extensions to the
	<a href="#extensions-performance-interface"><code>Performance</code></a> interface,
    which expose a high precision, monotonically increasing timestamp so they can better measure the performance characteristics of their applications.</p>

    <section class="informative">
      <p>The following script shows how a developer can use the interfaces defined in this document
  	to obtain timing data related to developer scripts.
      </p>
      <pre class="example highlight">
      &lt;!doctype html&gt;
      &lt;html&gt;
        &lt;head&gt;
          &lt;title&gt;User Timing example&lt;/title&gt;
        &lt;/head&gt;
        &lt;body onload="init()"&gt;
          &lt;script&gt;
             function init()
             {
                  performance.mark("startTask1");
                  doTask1(); // Some developer code
                  performance.mark("endTask1");

                  performance.mark("startTask2");
                  doTask2(); // Some developer code
                  performance.mark("endTask2");

                  measurePerf();
             }

             function measurePerf()
             {
                 var perfEntries = performance.getEntriesByType("mark");
                 for (var i = 0; i &lt; perfEntries.length; i++)
                 {
                       if (window.console) console.log("Name: "        + perfEntries[i].name      +
                                                       " Entry Type: " + perfEntries[i].entryType +
                                                       " Start Time: " + perfEntries[i].startTime +
                                                       " Duration: "   + perfEntries[i].duration  + "\n");
                 }
             }
          &lt;/script&gt;
        &lt;/body&gt;
      &lt;/html&gt;
      </pre>
    </section>
  </section>

  <section id="conformance">

    <p>Some conformance requirements are phrased as requirements on attributes,
    methods or objects. Such requirements are to be interpreted as requirements
    on user agents. </p>

    <p>The IDL fragments in this specification MUST be interpreted as
    required for conforming IDL fragments, as described in the Web IDL
    specification. [[!WebIDL]]</a></p>
  </section>

    <section id="extensions-performance-interface">
      <h2>Extensions to the <code>Performance</code> Interface</h2>

      <pre class="idl">
partial interface Performance {
    void mark(DOMString markName);
    void clearMarks(optional DOMString markName);

    void measure(DOMString measureName, optional DOMString startMark, optional DOMString endMark);
    void clearMeasures(optional DOMString measureName);
};
</pre>
  <p>The <dfn for="Performance" data-lt='mark'>mark(markName)</dfn> method stores a timestamp with the associated name (a "mark"). It MUST run these steps:</p>
  <ol>
    <li>If <var>markName</var> uses the same name as an attribute in the
        <code><a href="http://www.w3.org/TR/navigation-timing-2/#idl-def-PerformanceTiming">PerformanceTiming</a></code> interface [[!NAVIGATION-TIMING-2]], <a href='https://heycam.github.io/webidl/#dfn-throw'>throw</a> a <a href='https://heycam.github.io/webidl/#syntaxerror'><code>SyntaxError</code></a>.</li>
    <li>Create a new <a>PerformanceMark</a> object.</li>
    <li>Set <code>name</code> to <var>markName</var>.</var>
    <li>Set <code>entryType</code> to <code>DOMString "mark"</code>.
    <li>Set <code>startTime</code> to be the value that would be returned by the <code>Performance</code> object's <a href="http://w3c.github.io/hr-time/#dom-performance-now"><code>now()</code></a> method.</li>
    <li>Set <code>duration</code> to <code>0</code>.</li>
    <li><a href="https://w3c.github.io/performance-timeline/#dfn-queue-a-performanceentry">Queue</a> the <a>PerformanceMark</a> object.</li>
    <li id='stored_mark'>Add the <code>PerformanceMark</code> object to the <a href='https://w3c.github.io/performance-timeline/#dfn-performance-entry-buffer'>performance entry buffer</a>.</li>
    <li>Return <strong>undefined</strong>.</li>
  </ol>

  <p>The <dfn for="Performance" data-lt='clearMarks'>clearMarks(markName)</dfn> removes stored timestamp with the associated name. It MUST run these steps:</p>
  <ol>
    <li>If <var>markName</var> is omitted, remove all <a>PerformanceMark</a> objects from the <a href='https://w3c.github.io/performance-timeline/#dfn-performance-entry-buffer'>performance entry buffer</a>.</li>
    <li>Otherwise, remove all <a>PerformanceMark</a> objects listed in the <a href='https://w3c.github.io/performance-timeline/#dfn-performance-entry-buffer'>performance entry buffer</a> whose <var>name</var> matches<var>markName</var>.</li>
    <li>Return <strong>undefined</strong>.</li>
  </ol>

  <p>The <dfn for="Performance" data-lt='measure'>measure(measureName, startMark, endMark)</dfn> method stores the <code>DOMHighResTimeStamp</code> duration between two marks along with the associated name (a "measure"). It MUST run these steps:</p>
  <ol>
    <li>Let <var>end time</var> be 0.</li>
    <li>If <var>endMark</var> is omitted, let <var>end time</var> be the value that would be returned by the <code>Performance</code> object's <a href="http://w3c.github.io/hr-time/#dom-performance-now"><code>now()</code></a> method. Otherwise let <var>end time</var> be the value of the <code>startTime</code> attribute from the most recent occurence <a>PerformanceMark</a> object in <a>mark list</a> with a <code>name</code> attribute value equal to the value <var>endMark</var>.</li></li>
    <li>If <var>startMark</var> is omitted, let <var>start time</var> be 0. Otherwise let <var>start time</var> be the value of the <code>startTime</code> attribute from the most recent occurence <a>PerformanceMark</a> object in <a>mark list</a> with a <code>name</code> attribute value equals to the value <var>startMark</var>.</li></li>
    <li>Create a new <a>PerformanceMeasure</a> object.</li>
    <li>Set <code>name</code> to <var>measureName</var>.</var>
    <li>Set <code>entryType</code> to <code>DOMString "measure"</code>.
    <li>Set <code>startTime</code> to <var>start time</var>.</li>
    <li>Set <code>duration</code> to the duration from <var>start time</var> to <var>end time</var>. The resulting duration value MAY be negative.</li>
    <li><a href="https://w3c.github.io/performance-timeline/#dfn-queue-a-performanceentry">Queue</a> the <a>PerformanceMeasure</a> object.</li>
    <li id='stored_measure'>Add the <code>PerformanceMeasure</code> object to the <a href='https://w3c.github.io/performance-timeline/#dfn-performance-entry-buffer'>performance entry buffer</a>.</li>
    <li>Return <strong>undefined</strong>.</li>
  </ol>

    <p class='issue'>User Timing 1 included: The <em>startMark</em> and <em>endMark</em> arguments may be the name of one of the attributes in the
       <code><a href="http://www.w3.org/TR/navigation-timing-2/#idl-def-PerformanceTiming">PerformanceTiming</a></code> interface [[!NAVIGATION-TIMING-2]].
       In this case, the value of that attribute is used as the <a href="http://www.w3.org/TR/hr-time-2/#domhighrestimestamp"><code>DOMHighResTimeStamp</code></a> time value.</p>

  <p>The <dfn for="Performance" data-lt='clearMeasures'>clearMeasures(measureName)</dfn> removes stored timestamp with the associated name. It MUST run these steps:</p>
  <ol>
    <li>If <var>measureName</var> is omitted, remove all <a>PerformanceMeasure</a> objects in the <a href='https://w3c.github.io/performance-timeline/#dfn-performance-entry-buffer'>performance entry buffer</a>.</li>
    <li>Otherwise remove all <a>PerformanceMeasure</a> objects listed in the <a href='https://w3c.github.io/performance-timeline/#dfn-performance-entry-buffer'>performance entry buffer</a> whose <code>name</code> matches <var>measureName</var>.</li>
    <li>Return <strong>undefined</strong>.</li>
  </ol>

  </section>

  <section id="performancemark">
    <h2> The <code>PerformanceMark</code> Interface</h2>

    <p>
      The <dfn>PerformanceMark</dfn> interface also
    exposes marks created via the <a>Performance.mark</a>
    method to the
      <a href="http://www.w3.org/TR/performance-timeline-2/#sec-performance-timeline">Performance Timeline</a> [[!PERFORMANCE-TIMELINE-2]].
    </p>

    <pre class="idl">
  [Exposed=(Window,Worker)]
  interface PerformanceMark : PerformanceEntry {
  };
    </pre>

    <p>
    The <a>PerformanceMark</a>
		interface extends the following attributes of the <a href="http://www.w3.org/TR/performance-timeline-2/#performanceentry">PerformanceEntry</a>
		interface:
    </p>

        <p>The <code>name</code> attribute will return the mark's name.</p>
        <p>The <code>entryType</code> attribute will return the <a href='http://www.w3.org/TR/WebIDL/#idl-DOMString'><code>DOMString</code></a> <code>"mark"</code>.</p>
        <p>The <code>startTime</code> attribute will return a <a href="http://www.w3.org/TR/hr-time-2/#domhighrestimestamp"><code>DOMHighResTimeStamp</code></a>
		with the mark's time value [[!HR-TIME-2]].
    	</p>
        <p>The <code>duration</code> attribute will return a <a href="http://www.w3.org/TR/hr-time-2/#domhighrestimestamp"><code>DOMHighResTimeStamp</code></a>
		of value 0.</p>
  </section>

  <section id="performancemeasure">
    <h2>The <code>PerformanceMeasure</code> Interface</h2>
    <p>
      The <dfn>PerformanceMeasure</dfn> interface also
      exposes measures created via the <a>Performance.measure</a>
    method to the <a href="http://www.w3.org/TR/performance-timeline-2/#sec-performance-timeline">Performance Timeline</a> [[!PERFORMANCE-TIMELINE-2]].
    </p>
    <pre class="idl">
  [Exposed=(Window,Worker)]
  interface PerformanceMeasure : PerformanceEntry {
  };
    </pre>

	<p>
    The <a>PerformanceMeasure</a> interface extends the following attributes of the <a href="http://www.w3.org/TR/performance-timeline-2/#performanceentry">PerformanceEntry</a> interface:
    </p>

        <p>The <code>name</code> attribute will return the measure's name.</p>
        <p>The <code>entryType</code> attribute will return the <a href='http://www.w3.org/TR/WebIDL/#idl-DOMString'><code>DOMString</code></a> <code>"measure"</code>.</p>
        <p>The <code>startTime</code> attribute will return a <a href="http://www.w3.org/TR/hr-time-2/#domhighrestimestamp"><code>DOMHighResTimeStamp</code></a>
		with the measure's start mark [[!HR-TIME-2]].</p>
        <p>The <code>duration</code> attribute will return a <a href="http://www.w3.org/TR/hr-time-2/#domhighrestimestamp"><code>DOMHighResTimeStamp</code></a>
		with the duration of the measure. </p>
  </section>

    <section id="monotonic-clock">
    <h2>Monotonic Clock</h2>
    <p>The time values stored within the interface MUST monotonically increase to ensure they are not
    affected by adjustments to the system clock. The difference between any two chronologically
    recorded time values MUST never be negative. The user agent MUST record the system clock at the beginning
    of the navigation and define subsequent time values in terms of a monotonic clock measuring time elapsed
    from the beginning of the navigation.
    </p>
  </section>

  <section id="privacy-security" class='informative'>
	<h2>Privacy and Security</h2>

	<p>The interfaces defined in this specification	expose potentially sensitive timing information on specific JavaScript activity of a page.
	However, unlike other interfaces defined in [[PERFORMANCE-TIMELINE-2]]>,
	the interfaces defined in this specification do not have any restrictions on sharing timing information through script. This is because the web platform has been designed with the invariant that
	any script included on a page has the same access as any other script included on that page regardless of the origin of the script. </p>
</section>

    <section class="appendix">
      <h2>Acknowledgments</h2>

    <p>Thanks to Karen Anderson, Tony Gentilcore, Nic Jansma, James Simonsen, Steve Souders, Sigbjorn Vik, and Jason Weber for their useful comments that led to changes to this specification and their contributions to this work.</p>
  </section>
</section>
</body>

</html>
